<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=<device-width>, initial-scale=1.0" />
    <title>Document</title>
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.1/dist/css/bootstrap.min.css"
    />
  </head>
  <script src="https://d3js.org/d3.v7.min.js"></script>

  <body>
    <div class="container" style="margin-top: 80px">
      <div class="row">
        <div class="col-sm-7">
          <svg id="plot" style="width: 500px; height: 500px"></svg>
        </div>
        <div class="col-sm-5">
          <div id="output"></div>
        </div>
      </div>
      <button class="btn btn-primary tablinks" onclick="reset()">Reset</button>
      <p>
        Click on a red dot to select it. It will grow in size and turn green.
        Any selected dot can the be interrogated bu rolling mouse over it.
        Deselect the point by clicking on it again
      </p>
    </div>
  </body>

  <script>
    var edata;
    var dxMax, dxMin, dyMax, dyMin;

    const xSize = 500;
    const ySize = 500;
    const margin = 40;
    const xMax = xSize - margin * 2;
    const yMax = ySize - margin * 2;
    var xs;
    var ys;
    let  mdata;

    var yAxis = 1;
    var xAxis = 2;
    var year = 0;

    var d3Select = d3
      .select("#plot")
      .append("svg")
      .append("g")
      .attr("transform", "translate(" + margin + "," + margin + ")");

    var log = function (line) {
      console.log(line);
    };
    function parse(x) {
      if (x * 1 == x) {
        return x * 1;
      }
      return x;
    }

    var filter = function (fkey, value, subSet, data) {
      var dataSet = [];
      for (d in data) {
        if (data[d][fkey] == value) {
          var subDict = {};
          for ([key, val] of Object.entries(data[d])) {
            if (typeof data[d][key] == "number") {
              if (subSet.includes(key)) {
                subDict[key] = data[d][key];
              }
            }
          }
          dataSet.push(subDict);
        }
      }
      return dataSet;
    };

    var toSet = function (key, data) {
      var dataSet = new Set();
      for (d in data) {
        if (data[d][key] != undefined) {
          dataSet.add(data[d][key]);
        }
      }
      return Array.from(dataSet);
    };

    var doData = function (data) {
      for (var d = 0; d < data.length; d++) {
        for ([key, val] of Object.entries(data[d])) {
          data[d][key] = parse(val);
        }
      }
    };
    var process = function (data) {
      doData(data);
      let iterate = toSet("time", data);
      edata = filter(
        "time",
        iterate[year],
        ["id_person", "dag", "potentialearnings","time"],
        data
      );
      log(edata[0])
    };
    d3.csv("Data/Person.csv").then(
      function (d) {
        process(mdata)
        dxMin = d3.min(, function (d) {
          return d.dag;
        });
        dyMin = d3.min(edata, function (d) {
          return d.potentialearnings;
        });
        dxMax = d3.max(edata, function (d) {
          return d.dag;
        });
        dyMax = d3.max(edata, function (d) {
          return d.potentialearnings;
        });
        setup();
        draw();
      },
      function () {
        console.log("Error");
      }
    );
    var setup = function () {
      // X Axis
      xs = d3.scaleLinear().domain([dxMin, dxMax]).range([0, xMax]);

      d3Select
        .append("g")
        .attr("transform", "translate(0," + yMax + ")")
        .call(d3.axisBottom(xs));

      // Y Axis
      ys = d3.scaleLinear().domain([dyMin, dyMax]).range([yMax, 0]);

      d3Select.append("g").call(d3.axisLeft(ys));

      var display = function (d) {
        var htmlString = "<p>ID: " + data[d][0] + "</p>";

        for (let i = 1; i < data[d].length; i++) {
          htmlString += "<p>Val" + i + ": " + data[d][i] + "</p>";
        }
        document.getElementById("output").innerHTML = htmlString;
      };
    };

    var draw = function () {
      var list = d3Select.selectAll("circle").data(edata);
      list.join(
        (enter) =>
          enter
            .append(function(d){
                if(d["time"]==2018){
                    return "circle";
                } 
            })
            .attr("cx", function (d) {
                return xs(d["dag"] );
            })
            .attr("cy", function (d) {
              return ys(d["potentialearnings"]);
            })
            .attr("r", 1)
            .attr("id", function (d) {
              return d[0];
            })
            .style("fill", "red")
            .on("click", function () {
              this.toggle = !this.toggle; // declared variable setting it to true
              d3.select(this)
                .transition()
                .duration(1000)
                .attr("r", this.toggle ? 9 : 3)
                .style("fill", this.toggle ? "green" : "red");
            })
            .on("mouseover", function (d) {
              d3.select(this).attr("cursor", "pointer");
              if (this.toggle) {
                display(this.id);
                console.log(this.id);
              }
            })
            .on("mouseout", function () {}),
        (update) =>
          update
            .attr("cx", function (d) {
              return xs(d["dag"]);
            })
            .attr("cy", function (d) {
              return ys(d["potentialearnings"]);
            }),
        (exit) => exit.transition().duration(100).remove()
      );
    };

    var reset = function () {
      year++
      log(year)
      process(mdata)
      draw()
    };

    // var update = function () {
    //   //population.shuffle()

    //   for (let i = 0; i < data.length; i++) {
    //     for (let j = 1; j < data[i].length; j++) {
    //       data[i][j] += 1 - Math.random() * 2;
    //     }
    //   }
    //   if (data.length < 150) {
    //     data.push([
    //       data.length,
    //       Math.random() * (xMax - 30) + 15,
    //       Math.random() * (yMax - 30) + 15,
    //       Math.random() * (yMax - 30) + 15,
    //       Math.random() * (yMax - 30) + 15,
    //     ]);
    //   }
    //   draw();
    //   setTimeout(function () {
    //     window.requestAnimationFrame(update);
    //   }, 100);
    // };
  </script>
</html>
